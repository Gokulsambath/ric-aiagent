version: '3.8'

# Default logging configuration for all services (1 month retention)
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "20m"
    max-file: "10"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: ricagent-postgres
    restart: unless-stopped
    logging: *default-logging
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ricagoapi}
      POSTGRES_USER: ${POSTGRES_USER:-ricagoapi_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ricagent_postgres_data:/var/lib/postgresql/data
      - ./init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    ports:
      # Different port from AIProxysServ (5432)
      - "${POSTGRES_PORT:-5435}:5432"
    networks:
      - ricago-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ricagoapi_user} -d ${POSTGRES_DB:-ricagoapi}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Application
  ricagent-api:
    build:
      context: .
      dockerfile: Dockerfile
      cache_from:
        - ricagent-api:latest
      target: ""
    image: ricagent-api:latest
    container_name: ricagent-api
    restart: unless-stopped
    logging: *default-logging
    env_file:
      - .env
    environment:
      # Database Configuration
      DATABASE_TYPE: ${DATABASE_TYPE:-postgresql}
      DATABASE_URL: postgresql://${POSTGRES_USER:-ricagoapi_user}:${POSTGRES_PASSWORD:-changeme123}@ricagent-postgres:5432/${POSTGRES_DB:-ricagoapi}

      # Application Configuration
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: 8000
      SECRET_KEY: ${SECRET_KEY:-RICAGO_AGENT_KEY}

      # Botpress Integration (optional)
      BOTPRESS_URL: ${BOTPRESS_URL:-http://botpress:3000}

      # Ollama Configuration (Local - not used when using cloud)
      OLLAMA_API_URL: ${OLLAMA_API_URL:-https://ollama.com}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-gpt-oss:120b-cloud}

      # OpenAI-Compatible API (Ollama Cloud)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-e81e1546fd0b42eda763f75ea88f1b57.vbfSc4Z9xLPmc2EDA-lRH7uI}
      OPENAI_API_URL: ${OPENAI_API_URL:-https://ollama.com}
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-oss:120b-cloud}

      # Performance optimizations
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
    volumes:
      # Only mount for development - remove for production
      # - ./app:/app/app
      - ricagent_api_logs:/app/logs
    ports:
      - "${API_PORT:-5500}:8000"
    expose:
      - "8000"
    networks:
      - ricago-net
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Botpress Chatbot Platform
  botpress:
    image: botpress/server:latest
    container_name: ricagent-botpress
    restart: unless-stopped
    logging: *default-logging
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-ricagent_user}:${POSTGRES_PASSWORD:-changeme123}@ricagent-postgres:5432/${BOTPRESS_DB:-botpress}
      BP_MODULE_NLU_DUCKLINGURL: http://duckling:8000
      EXTERNAL_URL: https://ai.ricago.com/botpress
      BP_PRODUCTION: ${BP_PRODUCTION:-false}
    volumes:
      - ricagent_botpress_data:/botpress/data
    ports:
      # Different port from AIProxysServ (3000)
      - "${BOTPRESS_PORT:-5600}:3000"
    networks:
      - ricago-net
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:3000/botpress/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Duckling (NLU service for Botpress)
  duckling:
    image: rasa/duckling:latest
    container_name: ricagent-duckling
    restart: unless-stopped
    ports:
      # Different port from AIProxysServ (8001)
      - "8005:8000"
    networks:
      - ricago-net

  # PgAdmin (Postgres Dashboard)
  pgadmin:
    image: dpage/pgadmin4
    container_name: ricagent-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ricagent.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
    ports:
      # Different port from AIProxysServ (5050)
      - "${PGADMIN_PORT:-5055}:80"
    networks:
      - ricago-net
    depends_on:
      postgres:
        condition: service_healthy

  # Ollama Service
  ollama:
    image: ollama/ollama:latest
    container_name: ricagent-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11343:11434"
    networks:
      - ricago-net

  # Redis Cache
  redis:
    image: redis:alpine
    container_name: ricagent-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - ricago-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Frontend Widget (Next.js)
  ricagent-widget:
    build:
      context: ../ric-aiagent-widget
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_CHAT_API_URL: https://ai.ricago.com
    container_name: ricagent-widget
    restart: unless-stopped
    logging: *default-logging
    ports:
      - "3001:4000"
    environment:
      - NEXT_PUBLIC_CHAT_API_URL=https://ai.ricago.com
    networks:
      - ricago-net
    depends_on:
      - ricagent-api
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: ricagent-nginx
    restart: unless-stopped
    logging: *default-logging
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ../ssl:/ssl:ro
    depends_on:
      - ricagent-api
    networks:
      - ricago-net

  # ---------------------------------------------------------------------------
  # Monitoring Stack
  # ---------------------------------------------------------------------------

  # Loki: Log Aggregation System
  loki:
    image: grafana/loki:latest
    container_name: ricagent-loki
    restart: unless-stopped
    logging: *default-logging
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./monitoring/loki-config.yaml:/etc/loki/local-config.yaml
      - loki_data:/loki
    networks:
      - ricago-net

  # Promtail: Log Collector (ships logs to Loki)
  promtail:
    image: grafana/promtail:latest
    container_name: ricagent-promtail
    privileged: true
    restart: unless-stopped
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./monitoring/promtail-config.yaml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    networks:
      - ricago-net
    depends_on:
      - loki

  # Prometheus: Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: ricagent-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yaml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - ricago-net
    depends_on:
      - cadvisor

  # cAdvisor: Container Metrics (CPU, Memory, Network)
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: ricagent-cadvisor
    restart: unless-stopped
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    devices:
      - /dev/kmsg
    networks:
      - ricago-net

  # Grafana: Visualization Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: ricagent-grafana
    restart: unless-stopped
    logging: *default-logging
    ports:
      - "3005:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://ai.ricago.com/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
      - ./monitoring/grafana-dashboards.yaml:/etc/grafana/provisioning/dashboards/provider.yaml
      - ./monitoring/dashboards:/etc/grafana/dashboards
    networks:
      - ricago-net
    depends_on:
      - loki
      - prometheus

# Named volumes for data persistence
volumes:
  ricagent_postgres_data:
    name: ricagent_postgres_data
  ricagent_botpress_data:
    name: ricagent_botpress_data
  ricagent_api_logs:
    name: ricagent_api_logs
  ollama_data:
    name: ollama_data
  loki_data:
    name: loki_data
  prometheus_data:
    name: prometheus_data
  grafana_data:
    name: grafana_data

# Connect to existing network
networks:
  ricago-net:
    driver: bridge