version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: ricagent-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ric-aiagent}
      POSTGRES_USER: ${POSTGRES_USER:-ricagent_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme123}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ricagent_postgres_data:/var/lib/postgresql/data
      - ./init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    ports:
      # Different port from AIProxysServ (5432)
      - "${POSTGRES_PORT:-5435}:5432"
    networks:
      - ricago-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ricagent_user} -d ${POSTGRES_DB:-ric-aiagent}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Application
  ricagent-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ricagent-api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Database Configuration
      DATABASE_TYPE: ${DATABASE_TYPE:-postgresql}
      DATABASE_URL: postgresql://${POSTGRES_USER:-ricagent_user}:${POSTGRES_PASSWORD:-changeme123}@ricagent-postgres:5432/${POSTGRES_DB:-ric-aiagent}

      # Application Configuration
      API_HOST: ${API_HOST:-0.0.0.0}
      API_PORT: ${API_PORT:-8000}
      SECRET_KEY: ${SECRET_KEY:-RICAGO_AGENT_KEY}

      # Botpress Integration (optional)
      BOTPRESS_URL: ${BOTPRESS_URL:-http://botpress:3000}

      # Ollama Configuration
      OLLAMA_API_URL: ${OLLAMA_API_URL:-http://ollama:11434}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-llama3}
    volumes:
      - ./app:/app/app
      - ricagent_api_logs:/app/logs
    # ports:
    #   - "${API_PORT:-5500}:8000"
    expose:
      - "8000"
    networks:
      - ricago-net
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Botpress Chatbot Platform
  botpress:
    image: botpress/server:latest
    container_name: ricagent-botpress
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-ricagent_user}:${POSTGRES_PASSWORD:-changeme123}@ricagent-postgres:5432/${BOTPRESS_DB:-botpress}
      BP_MODULE_NLU_DUCKLINGURL: http://duckling:8000
      EXTERNAL_URL: ${BOTPRESS_EXTERNAL_URL:-http://localhost:3002}
      BP_PRODUCTION: ${BP_PRODUCTION:-false}
    volumes:
      - ricagent_botpress_data:/botpress/data
    ports:
      # Different port from AIProxysServ (3000)
      - "${BOTPRESS_PORT:-5600}:3000"
    networks:
      - ricago-net
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:3000/status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Duckling (NLU service for Botpress)
  duckling:
    image: rasa/duckling:latest
    container_name: ricagent-duckling
    restart: unless-stopped
    ports:
      # Different port from AIProxysServ (8001)
      - "8005:8000"
    networks:
      - ricago-net

  # PgAdmin (Postgres Dashboard)
  pgadmin:
    image: dpage/pgadmin4
    container_name: ricagent-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ricagent.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
    ports:
      # Different port from AIProxysServ (5050)
      - "${PGADMIN_PORT:-5055}:80"
    networks:
      - ricago-net
    depends_on:
      postgres:
        condition: service_healthy

  # Ollama Service
  ollama:
    image: ollama/ollama:latest
    container_name: ricagent-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11343:11434"
    networks:
      - ricago-net

  # Redis Cache
  redis:
    image: redis:alpine
    container_name: ricagent-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - ricago-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Frontend Widget (Next.js)
  ricagent-widget:
    build:
      context: ../ric-aiagent-widget
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_CHAT_API_URL: http://localhost:${API_PORT:-5500}
    container_name: ricagent-widget
    restart: unless-stopped
    ports:
      - "3001:4000"
    environment:
      - NEXT_PUBLIC_CHAT_API_URL=http://localhost:${API_PORT:-5500}
    networks:
      - ricago-net
    depends_on:
      - ricagent-api

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: ricagent-nginx
    restart: unless-stopped
    ports:
      - "5500:5500"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - ricagent-api
    networks:
      - ricago-net

# Named volumes for data persistence (Unique to this project)
volumes:
  ricagent_postgres_data:
    driver: local
  ricagent_botpress_data:
    driver: local
  ricagent_api_logs:
    driver: local
  ollama_data:
    driver: local

# Connect to existing network
networks:
  ricago-net:
    driver: bridge
